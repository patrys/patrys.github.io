---
layout: post
status: publish
published: true
title: 'Wego: Wtyczki'
author: Patrys
author_login: admin
author_email: patrys@pld-linux.org
author_url: http://room-303.com/blog/
wordpress_id: 365
wordpress_url: http://room-303.com/blog/2007/04/27/wego-wtyczki/
date: 2007-04-27 14:46:23.000000000 +02:00
categories:
- web
- software
- code
tags: []
comments:
- id: 7714
  author: nbw
  author_url: http://enbewu.net/blog/
  date: '2007-04-27 14:55:26 +0200'
  date_gmt: '2007-04-27 13:55:26 +0200'
  content: Sugeruję do logo ITS dodać brodę.
- id: 7715
  author: jarv
  author_url: http://monochrome.pl
  date: '2007-04-27 14:57:23 +0200'
  date_gmt: '2007-04-27 13:57:23 +0200'
  content: oj tam. w koncu sie ktorys ogoli i potem bedzie, ze mamy logo 'z brodą'...
    ;]
- id: 7716
  author: sit0
  author_url: http://sit0.com
  date: '2007-04-27 14:58:03 +0200'
  date_gmt: '2007-04-27 13:58:03 +0200'
  content: e tam, ja jestem bardziej kaloryczny :)
- id: 7718
  author: piotrek
  author_url: http://www.icenter.pl
  date: '2007-04-27 18:26:53 +0200'
  date_gmt: '2007-04-27 17:26:53 +0200'
  content: "Aż miło popatrzeć\r\nnasza brygada er-er..."
- id: 7719
  author: anghan
  author_url: http://anghan.jogger.pl
  date: '2007-04-27 21:49:54 +0200'
  date_gmt: '2007-04-27 20:49:54 +0200'
  content: Elektryzuje info o wydaniu darmowej wersji ;)
- id: 7720
  author: Luken
  author_url: http://luken.jogger.pl/
  date: '2007-04-27 22:16:45 +0200'
  date_gmt: '2007-04-27 21:16:45 +0200'
  content: "No widzę, że te Wego to naprawdę zaawansowany system. Jak najszybciej
    zrobić Wego darmowe. :)\r\n\r\nBTW. Kubki były razem z wyposażeniem biura? :P"
- id: 7721
  author: http-szabat.com-
  author_url: http://szabat.com/
  date: '2007-04-27 22:46:12 +0200'
  date_gmt: '2007-04-27 21:46:12 +0200'
  content: I jeszcze czekamy na wersje pythonową :)
- id: 7722
  author: Cypherq
  author_url: http://cypherq.wordpress.com/
  date: '2007-04-28 09:31:58 +0200'
  date_gmt: '2007-04-28 08:31:58 +0200'
  content: "O, miła niespodzianka. Tak właśnie myślałem, że jeśli zarys tego systemu
    wtyczek jednak się tutaj pojawi, to zapytam o jeszcze jedno, mianowicie kiedyś,
    dawno temu w notce jakiejś tam (Pinky blablabla chyba) stwierdziłeś, że:\r\n\r\n\"(panel
    — ze względu na szybkość rozwoju — nie operuje na kodzie HTML, zamiast tego budując
    interfejs za pomocą mechanizmu zagnieżdżanych kontrolek i kontenerów, wzorowanego
    na GTK+),\"\r\n\r\nChodzi o kolejną warstwę abstrakcji? Tak jak w ASP.NET? Bo
    nie wiem czy dobrze zrozumiałem. Oczywiście zdaję sobie sprawę, że masz na głowie
    ciekawsze sprawy, ale gdyby gdzieś kiedyś znalazł czas i mógł chociażby podać
    materiały na ten temat, byłoby smerfnie :]"
- id: 7723
  author: nbw
  author_url: http://enbewu.net/blog/
  date: '2007-04-28 12:25:58 +0200'
  date_gmt: '2007-04-28 11:25:58 +0200'
  content: "Luken: całe WEGO nie będzie darmowe. To system komercyjny od początku
    i takim pozostanie. Wersja darmowa do pobrania będzie oferować okrojoną funkcjonalność.\r\n\r\nSzabat:
    wersja pythonowa WEGO? Może jeśli python będzie serwerowo tak popularny jak PHP..."
- id: 7784
  author: Jakub
  author_url: http://www.mac-szkola.pl
  date: '2007-05-01 21:36:03 +0200'
  date_gmt: '2007-05-01 20:36:03 +0200'
  content: "Mi by starczył system newsów i artykułów :P I tyle mogłaby mieć wersja
    darmowa.\r\n\r\nAle zapaleńcy będą szukać full ver na torrentach i innych p2p
    :P"
- id: 7786
  author: Patrys
  author_url: http://room-303.com/
  date: '2007-05-02 10:37:49 +0200'
  date_gmt: '2007-05-02 09:37:49 +0200'
  content: "Jakub:\r\n\r\nNiech szukają. Samo Wego pobrać można za darmo, ale do uruchomienia
    potrzebny jest klucz, który obsługuje konkretną domenę ;)"
- id: 7787
  author: ehh
  author_url: ''
  date: '2007-05-02 14:06:03 +0200'
  date_gmt: '2007-05-02 13:06:03 +0200'
  content: A jakby im się udało pobrać za darmo źródło to ktoś by miał przechlapane:)
- id: 7889
  author: medyk
  author_url: http://getopenid.com/medyk
  date: '2007-05-12 02:57:44 +0200'
  date_gmt: '2007-05-12 01:57:44 +0200'
  content: W faktycznym kodzie wego też korzystacie z krótkich tagów?
- id: 7892
  author: Patrys
  author_url: http://room-303.com/
  date: '2007-05-13 19:55:17 +0200'
  date_gmt: '2007-05-13 18:55:17 +0200'
  content: "medyk:\r\n\r\nTeż, od czasów PHP3 nie widziałem serwera z wyłączonymi
    krótkimi tagami."
- id: 7893
  author: rozbit
  author_url: http://lukasz.rozbicki.net
  date: '2007-05-13 22:31:40 +0200'
  date_gmt: '2007-05-13 21:31:40 +0200'
  content: "Hmm, wyczytałem, że short_tags ma być wyłączone w php6 już, i że ogólnie
    zaleca się do nie używania tychże.\r\nTo jak to w końcu jest?"
- id: 7894
  author: medyk
  author_url: http://getopenid.com/medyk
  date: '2007-05-14 04:09:54 +0200'
  date_gmt: '2007-05-14 03:09:54 +0200'
  content: "ja mam wyłączone na każdym serwerze.. a najgorsze w krótkich tagach jest
    to, że jak masz je wyłączone to żadne błędy Ci się nie pojawią tylko kod php wyskoczy
    po stronie klienta - więc możecie powoli się nastawiać na różne dziwne historie..
    :)\r\nTwórcy php zalecają by z nich nie korzystać (w php6 ma już zdaje się ma
    już ich w ogóle nie być) i domyślna zalecana konfiguracja ostatnich 5-ek ma je
    wyłączone."
- id: 7895
  author: medyk
  author_url: http://getopenid.com/medyk
  date: '2007-05-14 04:12:31 +0200'
  date_gmt: '2007-05-14 03:12:31 +0200'
  content: aa nawet ostatnio miałem historię z klientem, który się do mnie zwrócił
    z pytaniem czemu u niego się wszystko wychrzania.. miał nową instalację php i
    krótkie tagi wyłączone.. nawet nie znał na tyle php by wiedzieć co to te krótkie
    tagi :)
- id: 7896
  author: Patrys
  author_url: http://room-303.com/
  date: '2007-05-14 11:02:47 +0200'
  date_gmt: '2007-05-14 10:02:47 +0200'
  content: U nas to nie ma wielkiego znaczenia, bo kod jest mielony przez ionCube
    do postaci bajtkodu. Dla nas ważne jest tylko wsparcie short_tags w ionCube ;)
---
<p>Wczoraj pisałem o dodaniu do <a href="http://cms.wego.pl/">Wego CMS</a> wtyczek dla systemów płatności online. <a href="http://room-303.com/blog/2007/04/26/wego-099/#comment-7711">Cypherq poprosił o szczegóły</a> dotyczące implementacji. Noszę się z zamiarem przygotowania kilkuetapowego howto, kiedy tylko pojawi się darmowa wersja Wego (tak, to bardzo możliwe, po szczegóły odsyłam do nbw). Póki co, o samym sposobie ładowania wtyczek.</p>

<h4>Moduły — wtyczki z automatyczną rejestracją</h4>

<p>Wego ma dwa rodzaje pluginów. Pierwszy rodzaj — wtyczki z automatyczną rejestracją — używany jest przez moduły. Moduł to zamknięta część systemu, widoczna jako osobna pozycja w panelu. Przykładem niech będą <q>Artykuły</q> lub <q>Kosz</q>.</p>

<p>Automatyczna rejestracja oznacza tyle, że plik z wtyczką zawiera klasę o nazwie takiej samej, jak plik i nie musi właściwie robić nic więcej:</p>

<pre><code>&lt;?

/* $Id: foo.module.php 1 2007-04-27 12:00:00Z patrys $ */

require_once(THE_ROOT . '/class/genericModule.class.php');

/**
 * Foo module
 */

class fooModule extends genericModule
{
	public function __construct(&amp; $modSys)
	{
		parent::__construct($modSys);
		$this-&gt;module = 'foo';
	}

	/**
	 * Check if module is usable (dependencies, etc.)
	 */
	protected function __public_init($data)
	{
		return array('success' =&gt; true);
	}

	/**
	 * Get module info
	 */
	public function getInfo()
	{
		return array
		(
			'title' =&gt; _('Foo'),
			'author' =&gt; 'patrys [ patrys at icenter pl ]',
			'version' =&gt; '1.0',
			'description' =&gt; _('Hello world example'),
			'modified' =&gt; filemtime(__FILE__)
		);
	}
}

?&gt;</code></pre>

<p>Do tego dochodzi klasa dla panelu administracyjnego (dla oszczędzenia pamięci, ładowana tylko w przypadku, gdy jest to aktywny moduł w panelu):</p>

<pre><code>&lt;?

/* $Id: foo.panel.module.php 1 2007-04-27 12:00:00Z patrys $ */

class fooPanelModule extends fooModule
{
	protected function __internal_list()
	{
		return 'Hello world!';
	}
}

?&gt;</code></pre>

<p>Jest tu kilka magicznych metod — wszystkie <code>__public_*</code> dostępne są automatycznie z poziomu inych modułów i z poziomu szablonów Smarty; <code>__internal_*</code> za to służą za obsługę ekranów panelu administracyjnego, wymagana jest przynajmniej obsługa metody <code>list</code>, która jest domyślnym widokiem.</p>

<h4>Inne wtyczki — ręczna rejestracja</h4>

<p>W przypadku wtyczek <q>pól dodatkowych</q> i systemów płatności okazało się, że automatyczna rejestracja nie jest najlepszym wyjściem — jedna klasa może realizować kilka funkcji, a sztuczne po niej dziedziczenie wprowadza tylko chaos w plikach. Zdecydowaliśmy się, że moduły te same muszą zgłosić obsługiwane przez siebie funkcje:</p>

<pre><code>&lt;?

/* $Id: platnosciPayment.class.php 7234 2007-04-25 10:55:39Z patrys $ */

class platnosciPaymentType extends genericPaymentType
{
	public static $paymentList = array
	(
		'platnosci_test' =&gt; array
		(
			'code' =&gt; 't',
			'name' =&gt; 'Platnosci.pl (płatność testowa)',
		),
		'platnosci_mtransfer' =&gt; array
		(
			'code' =&gt; 'm',
			'name' =&gt; 'Platnosci.pl - mBank mTransfer',
		),
		// [...]
		'platnosci_credit' =&gt; array
		(
			'code' =&gt; 'c',
			'name' =&gt; 'Platnosci.pl - Karta kredytowa',
		),
	);

	public function getConfigData()
	{
		// [...]
	}

	public function process()
	{
		// [...]
	}
}

$parent = paymentSystem::getInstance();
foreach (platnosciPaymentType::$paymentList as $key =&gt; $val)
	$parent-&gt;register($key, 'platnosciPaymentType', $val['name']);
$parent-&gt;registerSettings('platnosci', 'platnosciPaymentType', _('Platnosci.pl'));

?&gt;</code></pre>

<p>Dzięki temu możliwa jest obsługa wszystkich sposobów zapłaty za pomocą jednej klasy (konstruktor klasy <code>genericPaymentType</code> otrzymuje i zapisuje wybraną formę zapłaty).</p>

<h4>Ładowanie wtyczek</h4>

<p>Tutaj poszliśmy na łatwiznę:</p>

<pre><code>public function loadPlugins()
{
	$modDir = dir(THE_ROOT . '/payment/');

	while (($file = $modDir-&gt;read()) !== false)
	{
		$fullPath = THE_ROOT . '/payment/' . $file;

		if (!is_dir($fullPath))
		{
			include($fullPath);
		}
	}
}</code></pre>

<p>Ładowanie wtyczek z automatyczną rejestracją wymaga nieco więcej zachodu (po załadowaniu pliku, trzeba jeszcze sprawdzić, czy istnieje klasa o odpowiedniej nazwie i czy dziedziczy po odpowiedniej klasie bazowej), ale samodzielna implementacja nie powinna zająć więcej niż 5 minut.</p>

<h4>Na koniec</h4>

<p>Po notce o zmianie firmy pojawiły się niejasne spekulacje, jakobyśmy mieli zastąpić nbw butelką wody mineralnej. Spieszę z dowodem, że młodzieniec ów żyje i ma się dobrze (a jeśli już mielibyśmy kogoś zamienić na butelkę wody, to byłby to prędzej sit0).</p>

<p class="strip"><a href="http://www.flickr.com/photos/patrys/474498497/" title="Photo Sharing"><img src="http://farm1.static.flickr.com/231/474498497_af64a3a3ce.jpg" width="500" height="375" alt="The Crew" /></a><br />Ekipa, od lewej:<br />patrys, sit0, nbw, emes<br />jarv</p>
