---
layout: post
status: publish
published: true
title: 'Django: Pinax i Satchmo'
author: Patrys
author_login: admin
author_email: patrys@pld-linux.org
author_url: http://room-303.com/blog/
wordpress_id: 864
wordpress_url: http://room-303.com/blog/?p=864
date: 2010-04-18 16:17:48.000000000 +02:00
categories:
- software
tags: []
comments:
- id: 24969
  author: Piotr Sarnacki
  author_url: ''
  date: '2010-04-18 19:07:54 +0200'
  date_gmt: '2010-04-18 17:07:54 +0200'
  content: A zawsze zazdrościłem pythonowi pinaxa i myślałem, że można bezboleśnie
    i szybko dodać jakieś elementy społecznościówki do swojego kodu. Dobrze, że jak
    ostatnio miałem podejście do django, to nie wziąłem się też za pinaxa.
- id: 24972
  author: Tomash
  author_url: http://tomash.wrug.eu
  date: '2010-04-19 00:59:03 +0200'
  date_gmt: '2010-04-18 22:59:03 +0200'
  content: "Tak jak kolega wyżej -- jako rubiowiec zazdrościłem pythonowcom tej modularności
    django, ale jak widać sama możliwość nie zawsze starcza :] \r\n\r\nPatrys, a jak
    wygląda pokrycie testami tych projektów?"
- id: 24973
  author: Patrys
  author_url: http://room-303.com/blog/
  date: '2010-04-19 02:24:28 +0200'
  date_gmt: '2010-04-19 00:24:28 +0200'
  content: "Tomash:\r\n\r\nJa mówię, że spora część kodu w ogóle nie działa, a ty
    mnie pytasz o unit testing. Pytanie nie na miejscu ;)"
- id: 24975
  author: emes
  author_url: ''
  date: '2010-04-19 06:53:52 +0200'
  date_gmt: '2010-04-19 04:53:52 +0200'
  content: "Projektem Satchmo na stałe zajmują się dwie osoby. R+W do repo mam też
    ja i jeszcze może kilku ludzi, którzy kiedyś coś dołożyli. Taki mały i niezorganizowany
    zespół nie ma szans tego projektu kontrolować.\r\n\r\nOsobiście poprawiłem tonę
    bugów w Satchmo, napisałem jeden moduł płatności i powtórzyłem kilkukrotnie cały
    słownik znanych mi wulgaryzmów. Na posprzątanie kilku większych kup zwyczajnie
    nie starczyło mi czasu ani sił, a wielu fragmentów kodu nawet nie obejrzałem,
    jak choćby cytowanego przez Ciebie modułu płatności (ba, nawet nie wiem z jakim
    serwisem się on komunikuje).\r\n\r\nTen projekt ze słowem \"stabilność\" nie ma
    nic wspólnego i chyba nikt nawet nie próbował tego sugerować. Tym niemniej, szybciej
    i wygodniej jest użyć Satchmo niż pisać własny sklep od zera.\r\n\r\nPS: Kluczem
    do adaptowania Satchmo do własnych potrzeb jest system sygnałów."
- id: 24977
  author: yezooz
  author_url: ''
  date: '2010-04-19 14:09:08 +0200'
  date_gmt: '2010-04-19 12:09:08 +0200'
  content: tez chcialem od dawna przetestowac Satchmo i rowniez trafila sie okazja.
    Niestety zanim zorientowalem sie w co sie wpakowalem bylo juz za pozno. Bez gruntownych
    modyfikacji ilosc zapytan jakie jest w stanie wygenerowac Satchmo jest wrecz absurdalnie
    wysoka. Bardzo zaluje, ze nie wybralem czegos na PHP. Zdecydowanie nie polecam!
- id: 24979
  author: Secator
  author_url: http://secator.net
  date: '2010-04-19 19:45:25 +0200'
  date_gmt: '2010-04-19 17:45:25 +0200'
  content: Oszczędziłeś mi mase czasu :) dzięki!
- id: 24980
  author: Tomash
  author_url: http://tomash.wrug.eu
  date: '2010-04-19 21:34:25 +0200'
  date_gmt: '2010-04-19 19:34:25 +0200'
  content: "&gt; Ja mówię, że spora część kodu w ogóle nie działa, a ty mnie pytasz
    o unit testing. Pytanie nie na miejscu ;)\r\n\r\nPrzepraszam, reading comprehension
    fail ;) \r\n\r\nKurde, zatrolowałbym że w środowisku ruby projekty niepokryte
    testami są omijane szerokim łukiem, ale po pierwsze nie jest to do końca prawdą,
    a po drugie aż mi się szkoda zrobiło po przeczytaniu tego horror story."
- id: 25023
  author: owca
  author_url: ''
  date: '2010-05-04 15:21:44 +0200'
  date_gmt: '2010-05-04 13:21:44 +0200'
  content: dlatego jesli chodzi o sklepowanie, to ja uzywam LFS jako szkieletu a potem
    jazda z modyfikacjami.
- id: 25244
  author: Dreamwalker
  author_url: ''
  date: '2010-11-11 00:10:39 +0100'
  date_gmt: '2010-11-10 23:10:39 +0100'
  content: "Damn, rok za późno to przeczytałem i wkopałem się już w kilka stron w
    Pinaksie.\r\nZ resztą - już sam zauważyłem jaki jest \"cudowny\" -_-\r\n\r\nTeż
    myślałem już o własnym forku, ale skoro aż tak dużo kodu trzeba wyrzucać, to lepiej
    rzeczywiście wziąć się za budowę czegoś własnego i sprytną konwersję tego co jest
    -_-\r\n\r\nTak czy siak - dzięki!"
- id: 27891
  author: Być jak Satchmo | Room 303
  author_url: http://room-303.com/blog/2010/07/20/byc-jak-satchmo/
  date: '2012-02-24 16:51:19 +0100'
  date_gmt: '2012-02-24 15:51:19 +0100'
  content: '[...] pewnością naczytałeś się już, jakie to Satchmo nie jest doskonałe,
    zazdrościsz i chciałbyś stworzyć coś równie wspaniałego. Dość jednak nieprzespanych
    nocy, [...]'
- id: 28260
  author: Stu
  author_url: http://stuartaxon.com
  date: '2013-03-12 17:47:53 +0100'
  date_gmt: '2013-03-12 16:47:53 +0100'
  content: Eurgh, I'm trying to port the sagepay module to another payment architecture
    + that recursive loop is hitting me .. very annoying - not sure what it *should*
    be doing, but it seems pretty bad !
---
<p>Obiecywałem w skrócie przedstawić <q>cuda</q>, jakimi są oba projekty. Jak obiecałem, tak czynię.</p>

<h3>Marketing kołem napędowym gospodarki</h3>

<p>Oba projekty znałem od dość dawna z prasy, jaką zapewniają im deweloperzy i fani na wszelakich djangowych portalach, planetach i konferencjach. Na siłę używał ich nie będę — pomyślałem — ale może kiedyś się trafi okazja, to zobaczę, czym się tak wszyscy ekscytują. W bebechy nie zaglądałem, wiedziałem tylko, że jeden ma być uniwersalnym szkieletem dla wszelakich serwisów społecznościowych, a drugi klockami do budowy sklepów internetowych.</p>

<h3>Bliskie spotkania I stopnia</h3>

<p>Okazja się trafiła, choć nie taka, jak planowałem. Najpierw przyszło mi bowiem robić jedynie niewielkie poprawki we wdrożonym już serwisie opartym o Satchmo, później dopisać jakąś prostą aplikację do rozwijanej jeszcze społecznościówki, która do dzisiaj chyba nie dorobiła się ani wdrożenia, ani nawet nazwy.</p>

<p>Działać to działało, pod maskę nie bardzo miałem czas zaglądać. Dalszy kontakt sprowadzał się głównie do czytania samych superlatyw o owych — chciałoby się rzec — przebłyskach geniuszu inżynierii programowania.</p>

<h3>Pinax — pierwsza krew</h3>

<p>Do czasu. Jeden z kontraktów z <a href="http://mirumee.com/blog/">Mirumee</a> wymagał wbudowania w serwis podstawowych funkcji społecznościowych. Jednogłośnie zdecydowaliśmy się wypróbować Pinaksa.</p>

<p>Miesiąc później mieliśmy już własny fork, z którego systematycznie usuwaliśmy kawałki takiego kodu, że starczyłoby na doktorat z architektury oprogramowania. Obejścia na workaroundy, zaślepki na hackach. Widoki z pominięciem formularzy rozbierające request na zmienne i bez żadnej walidacji pakujące je do bazy. Widoki pozwalające na edycję cudzych obiektów, jeśli tylko znało się ich <code>id</code>. Aplikacje, które nie działały wcale, albo te działające częściowo, z resztą kodu wykomentowaną i otoczoną <code>FIXME</code>.</p>

<p>Jedno jest pewne, zmarnowaliśmy na to masę czasu i jeśli będę musiał do Pinaksa podejść drugi raz, to tylko po to, żeby ze strzelbą pod pachą wyprowadzić go na tyły domu.</p>

<h3>Początek przygody z Satchmo</h3>

<p>Całkiem niedawno zostaliśmy z kolei zakontraktowani przez firmę z UK, która specjalizuje się w budowie sklepów internetowych w Satchmo. Niestety programiści odeszli tuż po rozpoczęciu projektu i ktoś musiał zadanie skończyć. Chciałem poznać Satchmo, teraz miałem okazję. A dokładniej dwa tygodnie na przerobienie garści plików PNG z projektami graficznymi na w pełni działające wdrożenie.</p>

<p>Pierwsze dwa dni spędziłem na lekturze dokumentacji i doprowadzeniu kodu do działania na swojej maszynie. Szybko też okazało się, że Satchmo to taki sam zestaw klocków, jak Pinax czy — nie przymierzając — samochód. Oczywiście, można wymontować tylną kanapę i zmienić choinkę zapachową na lusterku, ale próba wyciągnięcia radia szybko pokazuje, że jest trwale przykręcone do kokpitu. Jakiekolwiek próby dopasowania sklepu do potrzeb sprzedawcy albo przypominają próbę ucharakteryzowania poloneza na ciągnik siodłowy z użyciem plasteliny, albo kończą się głęboką ingerencją w kod poszczególnych modułów.</p>

<h3>I wtedy zaczęły się schody</h3>

<p>Właśnie kontakt z modułami był pierwszym momentem, kiedy krzyknąłem <q>WTF</q>. Kiedy pierwszy raz miałem kontakt z Satchmo, poszczególne moduły i aplikacje mieszkały we wspólnej przestrzeni nazw <code>satchmo</code>. Okazuje się jednak, że ktoś wpadł na genialny pomysł zaoszczędzenia kilku literek i całość by działać musi zostać umieszczona bezpośrednio w ścieżce Pythona. Wielkie brawa za potencjalne konflikty nazw z innymi modułami Pythona oraz za zajęcie co bardziej oczywistych nazw dla lokalnych aplikacji projektu.</p>

<p>To jednak nie koniec, szybko okazało się, że dokumentacja to tylko ciekawostka, a jakiekolwiek pojęcie o działaniu całości daje dopiero lektura kodu. Tam można znaleźć prawdziwe perełki.</p>

<h4>Miłe złego początki</h4>

<p>Na początku było śmiesznie:</p>

<pre><code class="django">{% raw %}{% for product in products %} 
    {% if forloop.first %} &lt;ul&gt;  {% endif %}
        &lt;li&gt;{% thumbnail product.main_image.picture 85x85 as image %}
        &lt;a href="{{ product.get_absolute_url }}"&gt;&lt;img src="{{ image }}" width="{{ image.width }}" height="{{ image.height }}" /&gt;&lt;/a&gt;
        &lt;a href="{{ product.get_absolute_url }}"&gt;{{ product.translated_name }}&lt;/a&gt;&lt;/li&gt;
    {% if forloop.last %} &lt;/ul&gt; {% endif %}
{% endfor %}{% endraw %}</code></pre>

<p>Oczywiście, zdarza się, że pierwszy i ostatni element listy występują gdzieś w środku, dlatego bezpieczniej sprawdzić wszystkie.</p>

<h4>Powrót do przyszłości</h4>

<p>Wkrótce okazało się, że system płatności dla niektórych operatorów wymaga dodatkowo podania daty wystawienia karty. Z tym, że data wystawienia i ważności oferują ten sam zestaw opcji: od stycznia bieżącego roku, do grudnia za cztery lata. Cóż, widać karty starsze niż trzy miesiące nie są zbyt popularne, za do zdarzają się w obrocie karty wystawione za dwa lata.</p>

<h4>Działa doskonale, działa bez przerwy</h4>

<p>A co powiecie na nieskończoną pętlę rekurencji właśnie w module płatności?</p>

<pre><code class="python">def confirm_info(request, template='shop/checkout/protx/confirm.html', extra_context={}):
    payment_module = config_get_group('PAYMENT_PROTX')
    controller = confirm.ConfirmController(request, payment_module)
    # ...
    controller.onForm = secure3d_form_handler
    controller.confirm()
    return controller.response

# ...

def secure3d_form_handler(controller):
    """At the confirmation step, protx may ask for a secure3d authentication.  This method
    catches that, and if so, sends to that step, otherwise the form as normal"""
    
    if controller.processorReasonCode == '3DAUTH':
        # ...
        return http.HttpResponseRedirect(redirectUrl)
    
    return controller.onForm(controller)</code></pre>

<p>Ładnie, prawda?</p>

<h4>Telekonkurs dla naszych widzów</h4>

<p>Na koniec zagadka. Problem: podczas testów użytkownik opłacił za towar, ale na stronie z potwierdzeniem zamówienia pojawiła się informacja o nieudanej płatności. Rozwiązanie: okazuje się, że właściciel sklepu źle wypełnił pole na własny adres e-mail. Czy ktoś z was potrafi bez zaglądania w kod znaleźć logiczne powiązanie?</p>

<p>Otóż pole na e-mail obsługi sklepu nie jest typu <code>EmailField</code> i jest mu generalnie obojętne, jaką wartość się poda. System płatności zaś na koniec transakcji wysyła e-mail z potwierdzeniem na adres sklepu. W bloku o takiej konstrukcji:</p>

<pre><code class="python">try:
    self.response = dict([row.split('=', 1) for row in result.splitlines()])

    # ...

    return ProcessorResult(self.key, success, detail, payment=payment)

except Exception, e:
    self.log.info('Error submitting payment: %s', e)
    payment = self.record_failure(order=order, amount=amount,
        transaction_id="", reason_code="error",
        details='Invalid response from payment gateway')</code></pre>

<p>To oczywiście nie koniec. W kodzie można znaleźć takie wynalazki, jak:</p>

<ul>
<li>obiekt <code>NOTSET</code>, pełniący funkcję <code>None</code>;</li>
<li>aplikacja <code>livesettings</code>, umożliwiająca softcoding rzeczy, które powinny być w kodzie (niektóre z nich wymagają do działania restartu usługi, to się dopiero nazywa ironia);</li>
<li>bezmyślne zapychanie logów gdzie i czym popadnie;</li>
<li>i wiele, wiele innych.</li>
</ul>

<h3>Odpręż się, to nie będzie bolało</h3>

<p>Nie mam pojęcia, jak oba projekty wyrobiły sobie jakąkolwiek renomę. Pinax jest zwyczajnie niegroźną kupą kompostu, którą należy omijać z daleka albo mieć potem pretensję do samego siebie. Satchmo z kolei operuje cudzymi pieniędzmi.</p>

<p>Czy nie byłoby lepiej zamiast chwalić się udanymi wdrożeniami (chyba, że jest to chwalenie się na zasadzie: <q>nie wiem jakim cudem, ale się udało</q>), zająć się testowaniem własnego kodu? Już nie mówię nawet o poprawianiu go, żeby przypominał coś napisanego w Pythonie, wystarczy, żeby działała więcej niż jedna kombinacja, zaś zepsute i nietestowane od miesięcy moduły zostały w stosowny sposób oznaczone.</p>

<p>Mówiąc w skrócie, jestem na <q>nie</q>.</p>
